local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ContentProvider = game:GetService("ContentProvider")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- å¼•å…¥é…ç½®
local GameConfigModule = ReplicatedStorage:WaitForChild("GameConfig", 10)
if not GameConfigModule then warn("âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ° GameConfigï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å¤±æ•ˆ") end
local GameConfig = require(GameConfigModule)

-- å®‰å…¨è·å–äº‹ä»¶
local TutorialEvent = ReplicatedStorage:WaitForChild("TutorialEvent", 30)
if not TutorialEvent then warn("âŒ ä¸¥é‡é”™è¯¯ï¼šç­‰å¾… TutorialEvent è¶…æ—¶ï¼") end

-- ğŸ”¥ è°ƒè¯•å¼€å…³
local TEST_MODE = false 

-- ================= å˜é‡å®šä¹‰ (å…³é”®ä¿®å¤) =================
local lootCount = 0  -- ã€ä¿®å¤ã€‘å¿…é¡»åˆå§‹åŒ–ä¸º 0
local TOTAL_LOOT_NEEDED = 5 -- é»˜è®¤å€¼

-- å°è¯•ä»é…ç½®è¯»å–æ€»æ•°
if GameConfig and GameConfig.GetTotalLootCount then
	TOTAL_LOOT_NEEDED = GameConfig.GetTotalLootCount()
elseif GameConfig and GameConfig.Mobs and GameConfig.Mobs["Elite Zombie"] then
	-- å¦‚æœæ²¡æœ‰è¾…åŠ©å‡½æ•°ï¼Œæ‰‹åŠ¨è®¡ç®— (æ ¹æ®ä½ çš„ Config ç»“æ„)
	local drops = GameConfig.Mobs["Elite Zombie"].Drops
	local sum = 0
	if drops then
		for _, d in ipairs(drops) do sum = sum + d.Amount end
	end
	if sum > 0 then TOTAL_LOOT_NEEDED = sum end
end

local objective3Started = false 
local weaponConnections = {}
local isSelecting = false
local SelectedWeaponIndex = 0

local WeaponData = {
	[1] = { Name = "Knight's Sword", Desc = "Speed: Medium\nDamage: Balanced", Id = "Sword" },
	[2] = { Name = "Heavy Axe",      Desc = "Speed: Slow\nDamage: High",     Id = "Axe" },
	[3] = { Name = "Elven Bow",      Desc = "Speed: Fast\nDamage: Low",      Id = "Bow" }
}

local AUDIO_CLICK = "rbxassetid://12221967"
local AUDIO_RETURN_LAB = "rbxassetid://116952830538871"
local AUDIO_VO_2_2 = "rbxassetid://9114704332"
local AUDIO_VO_4_1 = "rbxassetid://0" 

local SoundPlayer = Instance.new("Sound")
SoundPlayer.Name = "StorySoundPlayer"
SoundPlayer.Parent = script

-- ================= 1. UI å¼•ç”¨ (åŠ¨æ€è·å–) =================
local function GetGameGui()
	return playerGui:FindFirstChild("GameGui")
end

local function GetUIElement(name, parent)
	if not parent then parent = GetGameGui() end
	if not parent then return nil end
	return parent:FindFirstChild(name, true) 
end

local function EnsureUI()
	local gui = GetGameGui()
	if not gui then return end

	-- æ£€æŸ¥ HotbarArrow
	if not gui:FindFirstChild("HotbarArrow") then
		local arrow = Instance.new("ImageLabel")
		arrow.Name = "HotbarArrow"
		arrow.Image = "rbxassetid://6813296229"
		arrow.Size = UDim2.new(0, 50, 0, 50)
		arrow.Position = UDim2.new(0.5, -25, 0.9, -60)
		arrow.BackgroundTransparency = 1
		arrow.Visible = false
		arrow.Parent = gui
	end

	-- æ£€æŸ¥ ControlsFrame
	if not gui:FindFirstChild("ControlsFrame") then
		local cf = Instance.new("Frame")
		cf.Name = "ControlsFrame"
		cf.Size = UDim2.new(0, 200, 0, 100)
		cf.Position = UDim2.new(1, -220, 0.8, 0)
		cf.BackgroundTransparency = 0.5
		cf.BackgroundColor3 = Color3.new(0,0,0)
		cf.Visible = false
		cf.Parent = gui

		local txt = Instance.new("TextLabel")
		txt.Size = UDim2.new(1,0,1,0)
		txt.BackgroundTransparency = 1
		txt.TextColor3 = Color3.new(1,1,1)
		txt.Text = "M1: Attack\nM2: Block\nShift: Sprint\nSpace: Jump"
		txt.Parent = cf
	end
end

-- ================= âœ¨ ç‰¹æ•ˆä¸å¼¹çª— âœ¨ =================

local function ShowLootNotification(itemName)
	local gui = GetGameGui()
	if not gui then return end

	local notifyFrame = gui:FindFirstChild("NotifyContainer")
	if not notifyFrame then
		notifyFrame = Instance.new("Frame")
		notifyFrame.Name = "NotifyContainer"
		notifyFrame.Size = UDim2.new(0, 200, 0, 300)
		notifyFrame.Position = UDim2.new(1, -220, 1, -320)
		notifyFrame.BackgroundTransparency = 1
		notifyFrame.Parent = gui

		local layout = Instance.new("UIListLayout")
		layout.Parent = notifyFrame
		layout.SortOrder = Enum.SortOrder.LayoutOrder
		layout.VerticalAlignment = Enum.VerticalAlignment.Bottom
		layout.Padding = UDim.new(0, 5)
	end

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, 0, 0, 40)
	label.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	label.BackgroundTransparency = 0.5
	label.TextColor3 = Color3.fromRGB(255, 255, 255)
	label.TextSize = 18
	label.Font = Enum.Font.GothamBold
	label.Text = "+1 " .. tostring(itemName)
	label.Parent = notifyFrame

	task.delay(2, function()
		if label and label.Parent then
			local tween = TweenService:Create(label, TweenInfo.new(1), {TextTransparency = 1, BackgroundTransparency = 1})
			tween:Play()
			tween.Completed:Connect(function() label:Destroy() end)
		end
	end)
end

local function MarkZombie(zombieModel)
	if not zombieModel then return end
	local arrow = Instance.new("BillboardGui")
	arrow.Name = "ZombieArrow"
	arrow.Size = UDim2.new(0,60,0,60)
	arrow.StudsOffset = Vector3.new(0, 5, 0)
	arrow.AlwaysOnTop = true
	arrow.Parent = zombieModel.PrimaryPart or zombieModel:FindFirstChild("Head")

	local img = Instance.new("ImageLabel", arrow)
	img.Size, img.BackgroundTransparency = UDim2.new(1,0,1,0), 1
	img.Image = "rbxassetid://6813296229" 
	img.ImageColor3 = Color3.fromRGB(255, 50, 50)

	local tInfo = TweenInfo.new(0.8, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true)
	TweenService:Create(arrow, tInfo, {StudsOffset = Vector3.new(0, 4, 0)}):Play()
end

local function ToggleHotbarArrow(state)
	local arrow = GetUIElement("HotbarArrow")
	if arrow then
		arrow.Visible = state
		if state then
			local tInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut, -1, true)
			TweenService:Create(arrow, tInfo, {ImageTransparency = 0.5}):Play()
		end
	end
end

-- ================= é€»è¾‘å‡½æ•° =================

local function PlayDialogue(text, audioId, pauseAfter, needClick)
	local dFrame = GetUIElement("DialogueFrame")
	if not dFrame then return end

	local dText = dFrame:FindFirstChild("ContentText")
	local pIcon = dFrame:FindFirstChild("PromptIcon")

	dFrame.Visible = true
	dFrame.AnchorPoint = Vector2.new(0.5, 1)
	dFrame.Position = UDim2.new(0.5, 0, 0.9, 0)

	if dText then
		dText.Text = "Battlemaster Dialogue Boxï¼š\n" .. text
		dText.AnchorPoint = Vector2.new(0.5, 0.5)
		dText.Position = UDim2.new(0.5, 0, 0.5, 0)
		dText.Size = UDim2.new(0.95, 0, 0.9, 0)
		dText.TextXAlignment = Enum.TextXAlignment.Center
	end

	if pIcon then pIcon.Visible = false end

	if audioId and audioId ~= "rbxassetid://0" then
		SoundPlayer.SoundId = audioId
		if not SoundPlayer.IsLoaded then ContentProvider:PreloadAsync({SoundPlayer}) end
		SoundPlayer:Play()
		local duration = SoundPlayer.TimeLength
		if duration > 0 then task.wait(duration) else task.wait(2) end
	end

	if pauseAfter > 0 then task.wait(pauseAfter) end

	if needClick and pIcon then
		pIcon.Visible = true
		local clicked = false
		local con
		con = UserInputService.InputBegan:Connect(function(inp)
			if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
				clicked = true
				con:Disconnect()
			end
		end)
		repeat task.wait() until clicked
	end
end

-- ================= æµç¨‹å‡½æ•° =================

local function InitiateObjective3()
	print(">>> ç›®æ ‡ #2 å®Œæˆï¼Œè¿›å…¥è¿‡æ¸¡é˜¶æ®µ <<<")
	PlayDialogue("Excellent work. Please return to the lab.", AUDIO_RETURN_LAB, 3, false)
	task.wait(1)
	TutorialEvent:FireServer("MoveToLab")

	local objFrame = GetUIElement("ObjectiveFrame")
	local ctrlFrame = GetUIElement("ControlsFrame")
	if objFrame then objFrame.Visible = false end
	if ctrlFrame then ctrlFrame.Visible = false end
end

local function StartObjective4()
	print("ğŸš€ ç›®æ ‡ #4 æµç¨‹å¯åŠ¨")
	PlayDialogue("Your collected mutagen extracts can be synthesized...", AUDIO_VO_4_1, 0, true)

	local dFrame = GetUIElement("DialogueFrame")
	if dFrame then dFrame.Visible = false end

	local objFrame = GetUIElement("ObjectiveFrame")
	if objFrame then
		local title = objFrame:FindFirstChild("Title")
		if title then title.Text = "NEW OBJECTIVE\nSynthesize Extracts" end
		objFrame.Visible = true
	end
end

local function StartObjective2()
	print("ğŸš€ ç›®æ ‡ #2 æµç¨‹å¯åŠ¨")
	PlayDialogue("Before engaging the enemy, be ready to draw your weapon at any moment.", AUDIO_VO_2_1, 0, true)

	local dFrame = GetUIElement("DialogueFrame")
	if dFrame then dFrame.Visible = false end

	ToggleHotbarArrow(true)

	local character = player.Character or player.CharacterAdded:Wait()
	local weaponEquipped = false

	if character:FindFirstChildWhichIsA("Tool") then weaponEquipped = true end
	if not weaponEquipped then
		local equipConn
		equipConn = character.ChildAdded:Connect(function(child)
			if child:IsA("Tool") then weaponEquipped = true equipConn:Disconnect() end
		end)
		repeat task.wait() until weaponEquipped
	end

	ToggleHotbarArrow(false)

	PlayDialogue("Practice using your weapon on the Zombies...", AUDIO_VO_2_2, 0, true)
	if dFrame then dFrame.Visible = false end

	local objFrame = GetUIElement("ObjectiveFrame")
	if objFrame then
		local title = objFrame:FindFirstChild("Title")
		if title then title.Text = "NEW OBJECTIVE\nEliminate Hostiles" end
		objFrame.Visible = true
	end

	TutorialEvent:FireServer("SpawnZombie")
	local ctrlFrame = GetUIElement("ControlsFrame")
	if ctrlFrame then ctrlFrame.Visible = true end
end

-- ================= æ­¦å™¨é€‰æ‹©æŒ‰é’®é€»è¾‘ =================
local function SetupWeaponButtons()
	local WeaponFrame = GetUIElement("WeaponSelectionFrame")
	if not WeaponFrame then warn("âŒ UI é”™è¯¯ï¼šæ‰¾ä¸åˆ° WeaponSelectionFrame") return end

	local InfoPanel = WeaponFrame:FindFirstChild("InfoPanel", true)
	if not InfoPanel then warn("âŒ UI é”™è¯¯ï¼šæ‰¾ä¸åˆ° InfoPanel") return end

	local StatsText = InfoPanel:FindFirstChild("StatsText")
	local SelectButton = InfoPanel:FindFirstChild("SelectButton")

	-- 1. æ–­å¼€æ—§è¿æ¥
	for _, conn in pairs(weaponConnections) do
		if conn then conn:Disconnect() end
	end
	weaponConnections = {}
	isSelecting = false 

	-- 2. ç»‘å®šæ­¦å™¨æŒ‰é’®
	for i = 1, 3 do
		local btn = WeaponFrame:FindFirstChild("Weapon"..i, true)
		if btn and btn:IsA("GuiButton") then
			btn.BorderSizePixel = 0
			local conn = btn.MouseButton1Click:Connect(function()
				SelectedWeaponIndex = i
				SoundPlayer.SoundId = AUDIO_CLICK
				SoundPlayer:Play()

				for j = 1, 3 do
					local other = WeaponFrame:FindFirstChild("Weapon"..j, true)
					if other then other.BorderSizePixel = 0 end
				end
				btn.BorderSizePixel = 5
				btn.BorderColor3 = Color3.fromRGB(255, 215, 0)

				InfoPanel.Visible = true
				if StatsText then
					local data = WeaponData[i]
					StatsText.Text = data.Name .. "\n\n" .. data.Desc
				end
			end)
			table.insert(weaponConnections, conn)
		end
	end

	-- 3. ç»‘å®šç¡®è®¤æŒ‰é’®
	if SelectButton then
		local selectConn = SelectButton.MouseButton1Click:Connect(function()
			if isSelecting then return end
			if SelectedWeaponIndex == 0 then return end

			isSelecting = true 
			SoundPlayer.SoundId = AUDIO_CLICK
			SoundPlayer:Play()

			WeaponFrame.Visible = false
			InfoPanel.Visible = false

			TutorialEvent:FireServer("GiveWeapon", WeaponData[SelectedWeaponIndex].Id)
			StartObjective2()
		end)
		table.insert(weaponConnections, selectConn)
	end
end

-- ================= ä¸»æµç¨‹ (æ— éŸ³é¢‘é€Ÿé€šç‰ˆ) =================
local function StartObjective1()
	print("ğŸš€ ç›®æ ‡ #1 æµç¨‹å¯åŠ¨ (æ— éŸ³é¢‘ç‰ˆ)")
	EnsureUI() 

	task.wait(0.5)

	local WeaponFrame = GetUIElement("WeaponSelectionFrame")
	if WeaponFrame then
		local objFrame = GetUIElement("ObjectiveFrame")
		if objFrame then objFrame.Visible = false end

		WeaponFrame.Visible = true
		SetupWeaponButtons()
		print("âœ… å·²è‡ªåŠ¨è·³è¿‡å¯¹è¯ï¼Œç›´æ¥æ‰“å¼€æ­¦å™¨é€‰æ‹©ç•Œé¢ã€‚")
	else
		warn("âŒ è‡ªåŠ¨å¼¹çª—å¤±è´¥ï¼šæ‰¾ä¸åˆ° WeaponSelectionFrame")
	end
end

-- ================= äº‹ä»¶ç›‘å¬ =================
TutorialEvent.OnClientEvent:Connect(function(action, data)
	if action == "StartObjective1" then
		StartObjective1()

	elseif action == "MarkZombie" then
		MarkZombie(data)

	elseif action == "StartObjective4" then
		StartObjective4()

	elseif action == "LootPickedUp" then
		-- data ç°åœ¨æ˜¯ç‰©å“åç§° (String)
		local itemName = data
		ShowLootNotification(itemName)

		lootCount = lootCount + 1 -- ã€ä¿®å¤ã€‘å˜é‡ç°åœ¨å·²å®šä¹‰ï¼Œä¸ä¼šæŠ¥é”™
		print("æ¡åˆ°äº† " .. lootCount .. " / " .. TOTAL_LOOT_NEEDED .. " ä¸ªç‰©å“")

		if lootCount >= TOTAL_LOOT_NEEDED and not objective3Started then
			objective3Started = true
			InitiateObjective3()
		end
	end
end)