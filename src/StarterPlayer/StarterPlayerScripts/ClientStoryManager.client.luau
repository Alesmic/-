local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local ContentProvider = game:GetService("ContentProvider")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local TutorialEvent = ReplicatedStorage:WaitForChild("TutorialEvent")

-- ğŸ”¥ è°ƒè¯•å¼€å…³
local TEST_MODE = false 

-- ================= 1. UI å¼•ç”¨ (åŠ¨æ€è·å–) =================
-- æˆ‘ä»¬ä¸å†åœ¨è„šæœ¬å¼€å¤´ä¸€æ¬¡æ€§æ­»é” UIï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªå‡½æ•°æ¥åŠ¨æ€è·å–
-- è¿™æ ·å³ä½¿ç©å®¶é‡ç”Ÿï¼ŒUI é‡ç½®ï¼Œè„šæœ¬ä¹Ÿèƒ½æ‰¾åˆ°æ–°çš„ UI
local function GetGameGui()
	return playerGui:FindFirstChild("GameGui")
end

local function GetUIElement(name, parent)
	if not parent then parent = GetGameGui() end
	if not parent then return nil end
	return parent:FindFirstChild(name, true) -- true è¡¨ç¤ºé€’å½’æŸ¥æ‰¾ï¼Œé˜²æ­¢å±‚çº§å˜åŠ¨æ‰¾ä¸åˆ°
end

-- è‡ªåŠ¨åˆ›å»ºç¼ºå¤± UI çš„è¾…åŠ©å‡½æ•°
local function EnsureUI()
	local gui = GetGameGui()
	if not gui then return end

	-- æ£€æŸ¥ HotbarArrow
	if not gui:FindFirstChild("HotbarArrow") then
		local arrow = Instance.new("ImageLabel")
		arrow.Name = "HotbarArrow"
		arrow.Image = "rbxassetid://6813296229"
		arrow.Size = UDim2.new(0, 50, 0, 50)
		arrow.Position = UDim2.new(0.5, -25, 0.9, -60)
		arrow.BackgroundTransparency = 1
		arrow.Visible = false
		arrow.Parent = gui
	end

	-- æ£€æŸ¥ ControlsFrame
	if not gui:FindFirstChild("ControlsFrame") then
		local cf = Instance.new("Frame")
		cf.Name = "ControlsFrame"
		cf.Size = UDim2.new(0, 200, 0, 100)
		cf.Position = UDim2.new(1, -220, 0.8, 0)
		cf.BackgroundTransparency = 0.5
		cf.BackgroundColor3 = Color3.new(0,0,0)
		cf.Visible = false
		cf.Parent = gui

		local txt = Instance.new("TextLabel")
		txt.Size = UDim2.new(1,0,1,0)
		txt.BackgroundTransparency = 1
		txt.TextColor3 = Color3.new(1,1,1)
		txt.Text = "M1: Attack\nM2: Block\nShift: Sprint\nSpace: Jump"
		txt.Parent = cf
	end
end

-- ================= 2. NPC ä¸æŒ‰é”® =================
print("å®¢æˆ·ç«¯ï¼šæ­£åœ¨è¿æ¥ NPC...")
local NPC = workspace:WaitForChild("BattlemasterNPC", 10)
if not NPC then warn("âš ï¸ æœªæ‰¾åˆ° BattlemasterNPCï¼") end

local RootPart = NPC and NPC:WaitForChild("HumanoidRootPart")
local ProximityPrompt = RootPart and RootPart:WaitForChild("ProximityPrompt", 5)

if RootPart and not ProximityPrompt then
	warn("âš ï¸ è‡ªåŠ¨åˆ›å»ºæŒ‰é”®...")
	ProximityPrompt = Instance.new("ProximityPrompt")
	ProximityPrompt.Parent = RootPart
end

if ProximityPrompt then
	ProximityPrompt.ObjectText = "Battlemaster"
	ProximityPrompt.ActionText = "Train"
	ProximityPrompt.KeyboardKeyCode = Enum.KeyCode.E
	ProximityPrompt.RequiresLineOfSight = false 
	ProximityPrompt.MaxActivationDistance = 15
	ProximityPrompt.Enabled = false 
end

-- ================= 3. éŸ³é¢‘ä¸æ•°æ® =================
local SoundPlayer = Instance.new("Sound")
SoundPlayer.Name = "StorySoundPlayer"
SoundPlayer.Parent = script

local AUDIO_CLICK = "rbxassetid://12221967"
local AUDIO_VO_1_1 = "rbxassetid://117374101600882" 
local AUDIO_VO_1_2 = "rbxassetid://89718167229984" 
local AUDIO_VO_1_3 = "rbxassetid://9114704332"
local AUDIO_VO_2_1 = "rbxassetid://9114704332" 
local AUDIO_VO_2_2 = "rbxassetid://9114704332" 
local AUDIO_RETURN_LAB = "rbxassetid://116952830538871"
local AUDIO_VO_4_1 = "rbxassetid://0" -- å ä½ç¬¦

local SelectedWeaponIndex = 0
local WeaponData = {
	[1] = { Name = "Knight's Sword", Desc = "Speed: Medium\nDamage: Balanced", Id = "Sword" },
	[2] = { Name = "Heavy Axe",      Desc = "Speed: Slow\nDamage: High",     Id = "Axe" },
	[3] = { Name = "Elven Bow",      Desc = "Speed: Fast\nDamage: Low",      Id = "Bow" }
}

local weaponConnections = {}
local isSelecting = false
local objective3Started = false 

-- ================= âœ¨ ç‰¹æ•ˆ âœ¨ =================
local blinkGui = nil 
local function StartBlinkingE()
	if not RootPart then return end
	if blinkGui then blinkGui:Destroy() end
	blinkGui = Instance.new("BillboardGui")
	blinkGui.Name = "BlinkingE"
	blinkGui.Size = UDim2.new(0, 50, 0, 50)
	blinkGui.StudsOffset = Vector3.new(0, 3.5, 0)
	blinkGui.AlwaysOnTop = true
	blinkGui.Parent = RootPart

	local textLabel = Instance.new("TextLabel")
	textLabel.Size = UDim2.new(1,0,1,0)
	textLabel.BackgroundTransparency = 1
	textLabel.Text = "E"
	textLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
	textLabel.TextStrokeTransparency = 0
	textLabel.TextScaled = true
	textLabel.Font = Enum.Font.GothamBlack
	textLabel.Parent = blinkGui

	local tweenInfo = TweenInfo.new(0.6, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true)
	TweenService:Create(textLabel, tweenInfo, {TextTransparency = 0.7}):Play()
end

local function StopBlinkingE()
	if blinkGui then blinkGui:Destroy() blinkGui = nil end
end

local zombieArrow = nil
local function MarkZombie(zombieModel)
	if not zombieModel then return end
	if zombieArrow then zombieArrow:Destroy() end
	zombieArrow = Instance.new("BillboardGui")
	zombieArrow.Size = UDim2.new(0,60,0,60)
	zombieArrow.StudsOffset = Vector3.new(0, 5, 0)
	zombieArrow.AlwaysOnTop = true
	zombieArrow.Parent = zombieModel.PrimaryPart or zombieModel:FindFirstChild("Head")

	local img = Instance.new("ImageLabel", zombieArrow)
	img.Size, img.BackgroundTransparency = UDim2.new(1,0,1,0), 1
	img.Image = "rbxassetid://6813296229" 
	img.ImageColor3 = Color3.fromRGB(255, 50, 50)

	local tInfo = TweenInfo.new(0.8, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true)
	TweenService:Create(zombieArrow, tInfo, {StudsOffset = Vector3.new(0, 4, 0)}):Play()
end

local function ToggleHotbarArrow(state)
	local arrow = GetUIElement("HotbarArrow")
	if arrow then
		arrow.Visible = state
		if state then
			local tInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut, -1, true)
			TweenService:Create(arrow, tInfo, {ImageTransparency = 0.5}):Play()
		end
	end
end

-- ================= é€»è¾‘å‡½æ•° =================

local function PlayDialogue(text, audioId, pauseAfter, needClick)
	local dFrame = GetUIElement("DialogueFrame")
	if not dFrame then warn("UIä¸¢å¤±: DialogueFrame") return end

	local dText = dFrame:FindFirstChild("ContentText")
	local pIcon = dFrame:FindFirstChild("PromptIcon")

	-- å¼ºåˆ¶ä¿®æ­£ä½ç½®
	dFrame.Visible = true
	dFrame.AnchorPoint = Vector2.new(0.5, 1)
	dFrame.Position = UDim2.new(0.5, 0, 0.9, 0)

	local fullText = "Battlemaster Dialogue Boxï¼š\n" .. text

	if dText then
		dText.Text = "" -- æ¸…ç©ºæ–‡æœ¬ï¼Œå‡†å¤‡æ‰“å­—æœºæ•ˆæœ
		-- å¼ºåˆ¶ä¿®æ­£æ–‡å­—ä½ç½®
		dText.AnchorPoint = Vector2.new(0.5, 0.5)
		dText.Position = UDim2.new(0.5, 0, 0.5, 0)
		dText.Size = UDim2.new(0.95, 0, 0.9, 0)
		dText.TextXAlignment = Enum.TextXAlignment.Center
		dText.TextYAlignment = Enum.TextYAlignment.Center
	end

	if pIcon then pIcon.Visible = false end

	-- æ’­æ”¾éŸ³é¢‘
	local duration = 0
	if audioId then
		SoundPlayer.SoundId = audioId
		if not SoundPlayer.IsLoaded then ContentProvider:PreloadAsync({SoundPlayer}) end
		SoundPlayer:Play()
		duration = SoundPlayer.TimeLength
		if duration <= 0 then duration = 2 end
	end

	-- ç›‘å¬ç‚¹å‡»è·³è¿‡
	local isSkipping = false
	local skipConn
	skipConn = UserInputService.InputBegan:Connect(function(input, gameProcessed)
		if gameProcessed then return end
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			isSkipping = true
		end
	end)

	-- 1. æ‰“å­—æœºæ•ˆæœ
	if dText then
		for i = 1, #fullText do
			if isSkipping then
				dText.Text = fullText
				break
			end
			dText.Text = string.sub(fullText, 1, i)
			task.wait(0.03)
		end
	end

	-- é‡ç½®è·³è¿‡çŠ¶æ€ (é˜²æ­¢ä¸€æ¬¡ç‚¹å‡»è·³è¿‡æ‰€æœ‰é˜¶æ®µ)
	if isSkipping then
		isSkipping = false
		task.wait(0.1) 
	end

	-- 2. ç­‰å¾…éŸ³é¢‘/æš‚åœ (æ”¯æŒè·³è¿‡)
	local totalWait = duration + pauseAfter
	local timer = 0
	while timer < totalWait do
		if isSkipping then
			if SoundPlayer.IsPlaying then SoundPlayer:Stop() end
			break
		end
		local dt = task.wait()
		timer = timer + dt
	end

	if skipConn then skipConn:Disconnect() end

	if needClick and pIcon then
		pIcon.Visible = true
		local clicked = false
		local con
		con = UserInputService.InputBegan:Connect(function(inp)
			if inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch then
				clicked = true
				con:Disconnect()
			end
		end)
		repeat task.wait() until clicked
	end
end

-- ================= æµç¨‹å‡½æ•° =================

local function InitiateObjective3()
	print(">>> ç›®æ ‡ #2 å®Œæˆï¼Œè¿›å…¥è¿‡æ¸¡é˜¶æ®µ <<<")
	PlayDialogue("Hello, example. Please return to your lab for instruction.", AUDIO_RETURN_LAB, 4, false)
	task.wait(1)
	TutorialEvent:FireServer("MoveToLab")

	local objFrame = GetUIElement("ObjectiveFrame")
	local ctrlFrame = GetUIElement("ControlsFrame")
	if objFrame then objFrame.Visible = false end
	if ctrlFrame then ctrlFrame.Visible = false end
end

local function StartObjective4()
	print("ğŸš€ ç›®æ ‡ #4 æµç¨‹å¯åŠ¨")
	PlayDialogue("Your collected mutagen extracts can be synthesized...", AUDIO_VO_4_1, 0, true)

	local dFrame = GetUIElement("DialogueFrame")
	if dFrame then dFrame.Visible = false end

	local objFrame = GetUIElement("ObjectiveFrame")
	if objFrame then
		local title = objFrame:FindFirstChild("Title")
		if title then title.Text = "NEW OBJECTIVE\nSynthesize Extracts" end
		objFrame.Visible = true
	end
end

local function StartObjective2()
	print("ğŸš€ ç›®æ ‡ #2 æµç¨‹å¯åŠ¨")
	PlayDialogue("Before engaging the enemy, be ready to draw your weapon at any moment.", AUDIO_VO_2_1, 0, true)

	local dFrame = GetUIElement("DialogueFrame")
	if dFrame then dFrame.Visible = false end

	ToggleHotbarArrow(true)

	local character = player.Character or player.CharacterAdded:Wait()
	local weaponEquipped = false

	if character:FindFirstChildWhichIsA("Tool") then weaponEquipped = true end
	if not weaponEquipped then
		local equipConn
		equipConn = character.ChildAdded:Connect(function(child)
			if child:IsA("Tool") then weaponEquipped = true equipConn:Disconnect() end
		end)
		repeat task.wait() until weaponEquipped
	end

	ToggleHotbarArrow(false)

	PlayDialogue("Practice using your weapon on the Zombie we captured...", AUDIO_VO_2_2, 0, true)
	if dFrame then dFrame.Visible = false end

	local objFrame = GetUIElement("ObjectiveFrame")
	if objFrame then
		local title = objFrame:FindFirstChild("Title")
		if title then title.Text = "NEW OBJECTIVE\nKill and loot Zombie" end
		objFrame.Visible = true
	end

	TutorialEvent:FireServer("SpawnZombie")
	local ctrlFrame = GetUIElement("ControlsFrame")
	if ctrlFrame then ctrlFrame.Visible = true end
end

-- ================= ä¿®å¤ï¼šæ­¦å™¨é€‰æ‹©æŒ‰é’®é€»è¾‘ =================
local function SetupWeaponButtons()
	-- é‡æ–°è·å– UI å¼•ç”¨ (é˜²æ­¢ nil)
	local WeaponFrame = GetUIElement("WeaponSelectionFrame")
	if not WeaponFrame then warn("âŒ UI é”™è¯¯ï¼šæ‰¾ä¸åˆ° WeaponSelectionFrame") return end

	local InfoPanel = WeaponFrame:FindFirstChild("InfoPanel", true) -- é€’å½’æŸ¥æ‰¾
	if not InfoPanel then warn("âŒ UI é”™è¯¯ï¼šæ‰¾ä¸åˆ° InfoPanel") return end

	local StatsText = InfoPanel:FindFirstChild("StatsText")
	local SelectButton = InfoPanel:FindFirstChild("SelectButton")

	-- 1. æ–­å¼€æ—§è¿æ¥
	for _, conn in pairs(weaponConnections) do
		if conn then conn:Disconnect() end
	end
	weaponConnections = {}
	isSelecting = false 

	-- 2. ç»‘å®šæ­¦å™¨æŒ‰é’®
	for i = 1, 3 do
		local btn = WeaponFrame:FindFirstChild("Weapon"..i, true) -- é€’å½’æŸ¥æ‰¾ï¼Œç¡®ä¿èƒ½æ‰¾åˆ°
		if btn and btn:IsA("GuiButton") then
			btn.BorderSizePixel = 0
			local conn = btn.MouseButton1Click:Connect(function()
				SelectedWeaponIndex = i
				SoundPlayer.SoundId = AUDIO_CLICK
				SoundPlayer:Play()

				-- UI æ›´æ–°
				for j = 1, 3 do
					local other = WeaponFrame:FindFirstChild("Weapon"..j, true)
					if other then other.BorderSizePixel = 0 end
				end
				btn.BorderSizePixel = 5
				btn.BorderColor3 = Color3.fromRGB(255, 215, 0)

				InfoPanel.Visible = true
				if StatsText then
					local data = WeaponData[i]
					StatsText.Text = data.Name .. "\n\n" .. data.Desc
				end
			end)
			table.insert(weaponConnections, conn)
		else
			warn("âš ï¸ è­¦å‘Šï¼šæ‰¾ä¸åˆ° Weapon"..i.." æˆ–è€…å®ƒä¸æ˜¯æŒ‰é’®")
		end
	end

	-- 3. ç»‘å®šç¡®è®¤æŒ‰é’®
	if SelectButton then
		local selectConn = SelectButton.MouseButton1Click:Connect(function()
			if isSelecting then return end
			if SelectedWeaponIndex == 0 then return end

			isSelecting = true 
			SoundPlayer.SoundId = AUDIO_CLICK
			SoundPlayer:Play()

			WeaponFrame.Visible = false
			InfoPanel.Visible = false
			TutorialEvent:FireServer("GiveWeapon", WeaponData[SelectedWeaponIndex].Id)

			PlayDialogue("A fine weapon choice...", AUDIO_VO_1_3, 0, true)

			local dFrame = GetUIElement("DialogueFrame")
			if dFrame then dFrame.Visible = false end

			StartObjective2()
		end)
		table.insert(weaponConnections, selectConn)
	else
		warn("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° SelectButton")
	end
end

-- ================= ä¸»æµç¨‹ =================
local function StartObjective1()
	print("ğŸš€ ç›®æ ‡ #1 æµç¨‹å¯åŠ¨")
	EnsureUI() -- ç¡®ä¿ UI å­˜åœ¨

	if not TEST_MODE then
		PlayDialogue("Welcome young exemplar...", AUDIO_VO_1_1, 3, false)
		PlayDialogue("Your weapon defines your combat style...", AUDIO_VO_1_2, 0, true)
		local dFrame = GetUIElement("DialogueFrame")
		if dFrame then dFrame.Visible = false end
		SoundPlayer:Stop()
	end

	local objFrame = GetUIElement("ObjectiveFrame")
	if objFrame then
		local title = objFrame:FindFirstChild("Title")
		if title then title.Text = "NEW OBJECTIVE\nChoose Your Weapon" end
		objFrame.Visible = true
	end

	if ProximityPrompt then
		ProximityPrompt.Enabled = true
		StartBlinkingE()
		print("âœ… E é”®é«˜äº®é—ªçƒå·²æ¿€æ´»")
	end
end

-- ================= äº‹ä»¶ç›‘å¬ =================
if ProximityPrompt then
	ProximityPrompt.Triggered:Connect(function()
		local objFrame = GetUIElement("ObjectiveFrame")
		if objFrame then objFrame.Visible = false end

		ProximityPrompt.Enabled = false 
		StopBlinkingE()

		local WeaponFrame = GetUIElement("WeaponSelectionFrame")
		if WeaponFrame then
			WeaponFrame.Visible = true
			SetupWeaponButtons() -- ç°åœ¨è¿™é‡Œå¾ˆå®‰å…¨
		else
			warn("âŒ è§¦å‘å¤±è´¥ï¼šWeaponSelectionFrame ä¸å­˜åœ¨")
		end
	end)
end

TutorialEvent.OnClientEvent:Connect(function(action, data)
	if action == "StartObjective1" then
		StartObjective1()
	elseif action == "MarkZombie" then
		MarkZombie(data)
	elseif action == "StartObjective4" then
		StartObjective4()
	elseif action == "LootPickedUp" then
		lootCount = lootCount + 1
		print("æ¡åˆ°äº† " .. lootCount .. " ä¸ªç‰©å“")
		if lootCount >= 5 and not objective3Started then
			objective3Started = true
			InitiateObjective3()
		end
	end
end)