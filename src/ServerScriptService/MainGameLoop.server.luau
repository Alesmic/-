local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local ServerStorage = game:GetService("ServerStorage")
local DataStoreService = game:GetService("DataStoreService")

local TutorialEvent = ReplicatedStorage:WaitForChild("TutorialEvent")
local StartLocation = Workspace:WaitForChild("TutorialStartLocation")
-- ä½¿ç”¨ FindFirstChild é˜²æ­¢å¦‚æœæ²¡æœ‰è¿™ä¸ªç‚¹å¯¼è‡´è„šæœ¬å¡æ­»
local ZombieSpawnPoint = Workspace:FindFirstChild("ZombieSpawnPoint")

-- å®‰å…¨è·å– DataStore (é˜²æ­¢æœªå¼€å¯ API Access å¯¼è‡´è„šæœ¬æŠ¥é”™åœæ­¢)
local PlayerDataStore
pcall(function()
	PlayerDataStore = DataStoreService:GetDataStore("PlayerData_v1")
end)

if not PlayerDataStore then
	warn("âš ï¸ è­¦å‘Š: DataStore æœªåŠ è½½ã€‚è¯·åœ¨ Game Settings -> Security ä¸­å¼€å¯ 'Enable Studio Access to API Services'ï¼Œå¦åˆ™æ•°æ®æ— æ³•ä¿å­˜ã€‚")
end

-- ç©å®¶æ•°æ®æ¨¡æ‹Ÿ (XP å’Œ ç”Ÿç‰©æ®‹æ¸£)
local PlayerStats = {} 

-- 1. ç©å®¶åŠ å…¥
Players.PlayerAdded:Connect(function(player)
	local success, savedData
	-- åªæœ‰å½“ DataStore æˆåŠŸåŠ è½½æ—¶æ‰å°è¯•è¯»å–
	if PlayerDataStore then
		success, savedData = pcall(function()
			return PlayerDataStore:GetAsync(tostring(player.UserId))
		end)
	end

	if success and savedData then
		PlayerStats[player.UserId] = savedData
		print("âœ… æˆåŠŸåŠ è½½ç©å®¶æ•°æ®")
	else
		PlayerStats[player.UserId] = { XP = 0, BioMatter = 0, LabInventory = {} } -- åˆå§‹åŒ–æ•°æ®
	end

	player.CharacterAdded:Wait()
	local character = player.Character

	if character and character.PrimaryPart then
		character:SetPrimaryPartCFrame(StartLocation.CFrame)
	else
		character:MoveTo(StartLocationwa.Position)
	end

	task.wait(1.5)
	TutorialEvent:FireClient(player, "StartObjective1")
	-- åˆå§‹ UI æ›´æ–°
	TutorialEvent:FireClient(player, "UpdateBioMatter", PlayerStats[player.UserId].BioMatter)
	TutorialEvent:FireClient(player, "UpdateXP", PlayerStats[player.UserId].XP)
end)

-- ç©å®¶ç¦»å¼€æ—¶ä¿å­˜æ•°æ®
Players.PlayerRemoving:Connect(function(player)
	local data = PlayerStats[player.UserId]
	if data and PlayerDataStore then
		pcall(function()
			PlayerDataStore:SetAsync(tostring(player.UserId), data)
		end)
	end
	PlayerStats[player.UserId] = nil
end)

-- æœåŠ¡å™¨å…³é—­æ—¶ä¿å­˜æ‰€æœ‰æ•°æ® (é˜²æ­¢æ•°æ®ä¸¢å¤±)
game:BindToClose(function()
	for _, player in ipairs(Players:GetPlayers()) do
		local data = PlayerStats[player.UserId]
		if data and PlayerDataStore then
			pcall(function()
				PlayerDataStore:SetAsync(tostring(player.UserId), data)
			end)
		end
	end
end)

-- è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ‰è½ç‰©
local function SpawnLoot(name, position, count, player)
	local lootFolder = ServerStorage:FindFirstChild("LootItems")
	local itemTemplate = lootFolder and lootFolder:FindFirstChild(name)

	if not itemTemplate then 
		warn("âŒ æ‰¾ä¸åˆ°æ‰è½ç‰©æ¨¡æ¿ï¼š"..name .. " (è¯·æ£€æŸ¥ ServerStorage/LootItems)") 
		return 
	end

	for i = 1, count do
		local loot = itemTemplate:Clone()
		-- éšæœºæ•£è½åœ¨å°¸ä½“å‘¨å›´
		loot.Position = position + Vector3.new(math.random(-3,3), 2, math.random(-3,3))
		loot.Parent = workspace

		-- ç¡®ä¿æ‰è½ç‰©æœ‰ç‰©ç†ç¢°æ’ï¼Œä¸ä¼šæ‰å‡ºä¸–ç•Œ
		if loot:IsA("BasePart") then
			loot.Anchored = false
			loot.CanCollide = true
		end

		-- æ·»åŠ æ‹¾å–é€»è¾‘ (Touch)
		local pickedUp = false
		loot.Touched:Connect(function(hit)
			if pickedUp then return end
			local char = hit.Parent
			local hitPlayer = Players:GetPlayerFromCharacter(char)

			if hitPlayer == player then
				pickedUp = true
				print("ğŸ“¦ ç©å®¶æ¡èµ·äº†: " .. name)

				-- å­˜å…¥å®éªŒå°åº“å­˜
				table.insert(PlayerStats[player.UserId].LabInventory, name)

				-- æ£€æŸ¥èƒŒåŒ…æˆ–æ‰‹ä¸­æ˜¯å¦å·²æœ‰è¯¥ç‰©å“ (ç”¨äºå †å )
				local existingTool = player.Backpack:FindFirstChild(name)
				if not existingTool and player.Character then
					existingTool = player.Character:FindFirstChild(name)
				end

				if existingTool then
					-- æƒ…å†µ A: å·²æœ‰ç‰©å“ï¼Œè¿›è¡Œå †å 
					local currentStack = existingTool:GetAttribute("Stack") or 1
					local newStack = currentStack + 1
					existingTool:SetAttribute("Stack", newStack)
					existingTool.ToolTip = name .. " x" .. newStack -- æ›´æ–°é¼ æ ‡æ‚¬åœæç¤º

					loot:Destroy() -- é”€æ¯åœ°ä¸Šçš„ç‰©ä½“
				else
					-- æƒ…å†µ B: æ–°ç‰©å“ï¼Œæ”¾å…¥èƒŒåŒ…
					local tool
					if loot:IsA("Tool") then
						tool = loot
						tool.Parent = player.Backpack
					else
						-- å¦‚æœæ‰è½ç‰©åªæ˜¯ Partï¼Œåˆ›å»ºä¸€ä¸ª Tool å®¹å™¨æ”¾å…¥èƒŒåŒ…
						tool = Instance.new("Tool")
						tool.Name = name
						tool.RequiresHandle = false -- ä¸éœ€è¦æ‰‹æŒæ¨¡å‹ï¼Œä»…ä½œä¸ºç‰©å“æ å›¾æ ‡
						tool.Parent = player.Backpack

						loot:Destroy()
					end

					-- åˆå§‹åŒ–å †å æ•°æ®
					tool:SetAttribute("Stack", 1)
					tool.ToolTip = name .. " x1"
				end

				-- é€šçŸ¥å®¢æˆ·ç«¯æ‹¾å–è¿›åº¦
				TutorialEvent:FireClient(player, "LootPickedUp", 1) 
			end
		end)
	end
end

-- 2. äº‹ä»¶ç›‘å¬
TutorialEvent.OnServerEvent:Connect(function(player, action, data)
	-- å‘æ­¦å™¨ (Objective 1)
	if action == "GiveWeapon" then
		local weaponFolder = ServerStorage:FindFirstChild("WeaponTools")
		if weaponFolder then
			local weapon = weaponFolder:FindFirstChild(data)
			if weapon then
				weapon:Clone().Parent = player.Backpack
				weapon:Clone().Parent = player.StarterGear
			end
		end

		-- ç”Ÿæˆåƒµå°¸ (Objective 2)
	elseif action == "SpawnZombie" then
		print("ğŸ§Ÿ æœåŠ¡å™¨ï¼šæ­£åœ¨ç”Ÿæˆç²¾è‹±åƒµå°¸...")

		if not ZombieSpawnPoint then
			warn("âŒ é”™è¯¯ï¼šWorkspace é‡Œæ²¡æœ‰ ZombieSpawnPointï¼Œæ— æ³•å®šä½åƒµå°¸ä½ç½®")
			return
		end

		local enemyFolder = ServerStorage:FindFirstChild("Enemies")
		local zombieTemplate = enemyFolder and enemyFolder:FindFirstChild("EliteZombie")

		if zombieTemplate then
			local zombie = zombieTemplate:Clone()
			zombie.Parent = workspace

			-- ğŸ›‘ è‡ªåŠ¨ä¿®å¤ PrimaryPart (é˜²æ­¢ç§»åŠ¨æŠ¥é”™)
			if not zombie.PrimaryPart then
				local root = zombie:FindFirstChild("HumanoidRootPart") or zombie:FindFirstChild("Torso") or zombie:FindFirstChild("Head")
				if root then zombie.PrimaryPart = root end
			end

			-- ç§»åŠ¨åƒµå°¸
			if zombie.PrimaryPart then
				zombie:SetPrimaryPartCFrame(ZombieSpawnPoint.CFrame)
			else
				zombie:MoveTo(ZombieSpawnPoint.Position)
			end

			-- é€šçŸ¥å®¢æˆ·ç«¯æ ‡è®°è¿™ä¸ªåƒµå°¸ (åŠ ç®­å¤´)
			TutorialEvent:FireClient(player, "MarkZombie", zombie)

			-- ç›‘å¬åƒµå°¸æ­»äº¡
			local humanoid = zombie:FindFirstChild("Humanoid")
			if humanoid then
				humanoid.Died:Connect(function()
					print("ğŸ’€ åƒµå°¸å·²æ­»äº¡ï¼å‘æ”¾å¥–åŠ±...")

					-- 1. åŠ  XP å’Œ ç”Ÿç‰©æ®‹æ¸£
					local stats = PlayerStats[player.UserId]
					stats.XP = stats.XP + 300
					stats.BioMatter = stats.BioMatter + 3
					print("ç©å®¶è·å¾— 300 XP, å½“å‰æ€»é‡: " .. stats.XP)

					-- æ›´æ–°å®¢æˆ·ç«¯ UI
					TutorialEvent:FireClient(player, "UpdateBioMatter", stats.BioMatter)
					TutorialEvent:FireClient(player, "UpdateXP", stats.XP)

					-- 2. æ‰è½ç‰©å“ (ğŸ›‘ ä¿®å¤ç‚¹ï¼šä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼è·å–ä½ç½®)
					local dropPos = zombie:GetPivot().Position -- è¿™æ ·å†™æ— è®ºæœ‰æ²¡æœ‰RootPartéƒ½èƒ½æ‰¾åˆ°ä½ç½®

					SpawnLoot("CommonExtract", dropPos, 3, player) -- 3ä¸ªæ™®é€š
					SpawnLoot("RareExtract", dropPos, 2, player)   -- 2ä¸ªç½•è§

					-- 3. æ¸…ç†å°¸ä½“ (å»¶è¿Ÿ)
					game:GetService("Debris"):AddItem(zombie, 5)
				end)
			end
		else
			warn("âŒ é”™è¯¯ï¼šServerStorage/Enemies é‡Œæ²¡æ‰¾åˆ° EliteZombie æ¨¡å‹ï¼")
		end
	end
end)