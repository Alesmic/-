local ServerScriptService = game:GetService("ServerScriptService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Debris = game:GetService("Debris")

-- å¼•å…¥é…ç½®
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

-- äº‹ä»¶å¼•ç”¨
local TutorialEvent = ReplicatedStorage:WaitForChild("TutorialEvent")
local ToggleWaypointEvent = ReplicatedStorage:WaitForChild("ToggleWaypointEvent")

-- é¢„åˆ¶ä»¶å¼•ç”¨
local ZombieTemplate = game.ServerStorage.Enemies:WaitForChild("EliteZombie")
local LootTemplate = game.ServerStorage:FindFirstChild("LootPart") 
-- æ³¨æ„ï¼šå¦‚æœ ServerStorage é‡Œæ²¡æœ‰ LootPartï¼Œè¯·åˆ›å»ºä¸€ä¸ªç®€å•çš„ Part å« "LootPart" å¹¶æ”¾å…¥ ServerStorage

-- [ä¿®æ”¹åçš„æ‰è½ç”Ÿæˆå‡½æ•°ï¼šæ”¯æŒé¢œè‰²]
local function SpawnLoot(itemName, position, count, player, colorType)
	for i = 1, count do
		local loot = LootTemplate:Clone()
		if not loot then -- å¦‚æœæ²¡æœ‰æ¨¡æ¿ï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„
			loot = Instance.new("Part")
			loot.Size = Vector3.new(1, 1, 1)
			loot.Anchored = false
			loot.CanCollide = true
			loot.Shape = Enum.PartType.Ball
		end

		loot.Name = itemName
		-- éšæœºæ•£å¼€ä¸€ç‚¹
		loot.Position = position + Vector3.new(math.random(-3,3), 5, math.random(-3,3))
		loot.Parent = workspace

		-- è®¾ç½®é¢œè‰²
		if colorType == "Red" then
			loot.Color = Color3.fromRGB(255, 50, 50)     -- çº¢è‰² (ç”Ÿç‰©è´¨)
		elseif colorType == "Green" then
			loot.Color = Color3.fromRGB(50, 255, 50)     -- ç»¿è‰²
		else
			loot.Color = Color3.fromRGB(50, 150, 255)    -- è“è‰² (æ™®é€šæå–ç‰©)
		end

		-- æ·»åŠ æ¥è¿‘æç¤º (Eé”®æ‹¾å–)
		local prompt = Instance.new("ProximityPrompt")
		prompt.ObjectText = "Loot"
		prompt.ActionText = "Pick up " .. itemName
		prompt.HoldDuration = 0
		prompt.MaxActivationDistance = 10
		prompt.Parent = loot

		prompt.Triggered:Connect(function(triggerPlayer)
			if triggerPlayer == player then
				-- å‘é€æ¡èµ·äº‹ä»¶ç»™å®¢æˆ·ç«¯ (åŒ…å«åå­—ï¼Œç”¨äºå¼¹çª—)
				TutorialEvent:FireClient(player, "LootPickedUp", itemName)
				loot:Destroy()
			end
		end)

		Debris:AddItem(loot, 60) -- 60ç§’åè‡ªåŠ¨æ¶ˆå¤±
	end
end

-- [ä¿®æ”¹åçš„ç”Ÿæˆå•ä¸ªåƒµå°¸å‡½æ•°]
local function SpawnSpecificZombie(player, zombieType, offset)
	local config = GameConfig.Zombies[zombieType]
	if not config then return end

	local zombie = ZombieTemplate:Clone()
	zombie.Name = config.Name
	zombie.Parent = workspace

	-- 1. è®¾ç½®ä½ç½® (åœ¨ç©å®¶å‰æ–¹ + åç§»)
	local character = player.Character
	if character then
		local pivot = character:GetPivot()
		zombie:PivotTo(pivot * CFrame.new(offset, 0, -20)) -- åç§»ä½ç½®
	end

	-- 2. è®¾ç½®å±æ€§ (è¡€é‡ã€å¤§å°)
	local humanoid = zombie:WaitForChild("Humanoid")
	humanoid.MaxHealth = config.HP
	humanoid.Health = config.HP

	-- 3. æ·»åŠ æè¾¹ (Highlight)
	local highlight = Instance.new("Highlight")
	highlight.FillTransparency = 1 -- å†…éƒ¨é€æ˜
	highlight.OutlineTransparency = 0
	highlight.OutlineColor = config.OutlineColor
	highlight.Adornee = zombie
	highlight.Parent = zombie

	-- 4. æ ‡è®°ç»™å®¢æˆ·ç«¯ (æ˜¾ç¤ºç®­å¤´)
	TutorialEvent:FireClient(player, "MarkZombie", zombie)

	-- 5. æ­»äº¡é€»è¾‘
	humanoid.Died:Connect(function()
		print("ğŸ’€ " .. config.Name .. " å·²æ­»äº¡")

		-- ç»™å¥–åŠ± (XP, MTC ç­‰)
		local leaderstats = player:FindFirstChild("leaderstats")
		if leaderstats then
			-- è¿™é‡Œå¯ä»¥æ ¹æ® config.XP åŠ ç»éªŒï¼Œæš‚ç•¥
			local bio = leaderstats:FindFirstChild("Biomass")
			-- å¦‚æœæ˜¯ç²¾è‹±æ€ªï¼Œå¯ä»¥åŠ æ•°æ®
			if zombieType == "Elite" and bio then
				bio.Value = bio.Value + 3
			end
		end

		-- ç”Ÿæˆæ‰è½ç‰©
		local dropPos = zombie:GetPivot().Position
		for _, dropData in ipairs(config.Drops) do
			SpawnLoot(dropData.Name, dropPos, dropData.Count, player, dropData.Color)
		end

		Debris:AddItem(zombie, 5)
	end)
end

-- [ä¸»ç›‘å¬]
TutorialEvent.OnServerEvent:Connect(function(player, action, data)
	if action == "SpawnZombie" then
		print("ğŸ§Ÿ å¼€å§‹ç”ŸæˆåŒåƒµå°¸æ³¢æ¬¡...")
		-- ç”Ÿæˆæ™®é€šåƒµå°¸ (è“è‰²ï¼Œå·¦è¾¹)
		SpawnSpecificZombie(player, "Normal", -5)

		-- ç”Ÿæˆç²¾è‹±åƒµå°¸ (çº¢è‰²ï¼Œå³è¾¹)
		SpawnSpecificZombie(player, "Elite", 5)

	elseif action == "MoveToLab" then
		-- (è¿™éƒ¨åˆ†ä»£ç ä¿æŒä½ åŸæœ¬çš„ GameFlowController é€»è¾‘ï¼Œæˆ–è€…å¦‚æœåœ¨è¿™é‡Œä¹Ÿæœ‰å¤„ç†ï¼Œè¯·ä¿ç•™)
		-- è¿™é‡Œå¦‚æœä¸å¤„ç†ä¼ é€ï¼Œå°±åœ¨ GameFlowController é‡Œå¤„ç†
	end
end)