local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local ServerStorage = game:GetService("ServerStorage")

local TutorialEvent = ReplicatedStorage:WaitForChild("TutorialEvent")
local StartLocation = Workspace:WaitForChild("TutorialStartLocation")
-- ä½¿ç”¨ FindFirstChild é˜²æ­¢å¦‚æœæ²¡æœ‰è¿™ä¸ªç‚¹å¯¼è‡´è„šæœ¬å¡æ­»
local ZombieSpawnPoint = Workspace:FindFirstChild("ZombieSpawnPoint")

-- ç©å®¶æ•°æ®æ¨¡æ‹Ÿ (XP å’Œ ç”Ÿç‰©æ®‹æ¸£)
local PlayerStats = {} 

-- 1. ç©å®¶åŠ å…¥
Players.PlayerAdded:Connect(function(player)
	PlayerStats[player.UserId] = { XP = 0, BioMatter = 0, LabInventory = {} } -- åˆå§‹åŒ–æ•°æ®

	player.CharacterAdded:Wait()
	local character = player.Character

	if character and character.PrimaryPart then
		character:SetPrimaryPartCFrame(StartLocation.CFrame)
	else
		character:MoveTo(StartLocation.Position)
	end

	task.wait(1.5)
	TutorialEvent:FireClient(player, "StartObjective1")
end)

-- è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ‰è½ç‰©
local function SpawnLoot(name, position, count, player)
	local lootFolder = ServerStorage:FindFirstChild("LootItems")
	local itemTemplate = lootFolder and lootFolder:FindFirstChild(name)

	if not itemTemplate then 
		warn("âŒ æ‰¾ä¸åˆ°æ‰è½ç‰©æ¨¡æ¿ï¼š"..name .. " (è¯·æ£€æŸ¥ ServerStorage/LootItems)") 
		return 
	end

	for i = 1, count do
		local loot = itemTemplate:Clone()
		-- éšæœºæ•£è½åœ¨å°¸ä½“å‘¨å›´
		loot.Position = position + Vector3.new(math.random(-3,3), 2, math.random(-3,3))
		loot.Parent = workspace

		-- ç¡®ä¿æ‰è½ç‰©æœ‰ç‰©ç†ç¢°æ’ï¼Œä¸ä¼šæ‰å‡ºä¸–ç•Œ
		if loot:IsA("BasePart") then
			loot.Anchored = false
			loot.CanCollide = true
		end

		-- æ·»åŠ æ‹¾å–é€»è¾‘ (Touch)
		local pickedUp = false
		loot.Touched:Connect(function(hit)
			if pickedUp then return end
			local char = hit.Parent
			local hitPlayer = Players:GetPlayerFromCharacter(char)

			if hitPlayer == player then
				pickedUp = true
				print("ğŸ“¦ ç©å®¶æ¡èµ·äº†: " .. name)

				-- å­˜å…¥å®éªŒå°åº“å­˜
				table.insert(PlayerStats[player.UserId].LabInventory, name)

				loot:Destroy()

				-- é€šçŸ¥å®¢æˆ·ç«¯æ‹¾å–è¿›åº¦
				TutorialEvent:FireClient(player, "LootPickedUp") 
			end
		end)
	end
end

-- 2. äº‹ä»¶ç›‘å¬
TutorialEvent.OnServerEvent:Connect(function(player, action, data)
	-- å‘æ­¦å™¨ (Objective 1)
	if action == "GiveWeapon" then
		local weaponFolder = ServerStorage:FindFirstChild("WeaponTools")
		if weaponFolder then
			local weapon = weaponFolder:FindFirstChild(data)
			if weapon then
				weapon:Clone().Parent = player.Backpack
				weapon:Clone().Parent = player.StarterGear
			end
		end

		-- ç”Ÿæˆåƒµå°¸ (Objective 2)
	elseif action == "SpawnZombie" then
		print("ğŸ§Ÿ æœåŠ¡å™¨ï¼šæ­£åœ¨ç”Ÿæˆç²¾è‹±åƒµå°¸...")

		if not ZombieSpawnPoint then
			warn("âŒ é”™è¯¯ï¼šWorkspace é‡Œæ²¡æœ‰ ZombieSpawnPointï¼Œæ— æ³•å®šä½åƒµå°¸ä½ç½®")
			return
		end

		local enemyFolder = ServerStorage:FindFirstChild("Enemies")
		local zombieTemplate = enemyFolder and enemyFolder:FindFirstChild("EliteZombie")

		if zombieTemplate then
			local zombie = zombieTemplate:Clone()
			zombie.Parent = workspace

			-- ğŸ›‘ è‡ªåŠ¨ä¿®å¤ PrimaryPart (é˜²æ­¢ç§»åŠ¨æŠ¥é”™)
			if not zombie.PrimaryPart then
				local root = zombie:FindFirstChild("HumanoidRootPart") or zombie:FindFirstChild("Torso") or zombie:FindFirstChild("Head")
				if root then zombie.PrimaryPart = root end
			end

			-- ç§»åŠ¨åƒµå°¸
			if zombie.PrimaryPart then
				zombie:SetPrimaryPartCFrame(ZombieSpawnPoint.CFrame)
			else
				zombie:MoveTo(ZombieSpawnPoint.Position)
			end

			-- é€šçŸ¥å®¢æˆ·ç«¯æ ‡è®°è¿™ä¸ªåƒµå°¸ (åŠ ç®­å¤´)
			TutorialEvent:FireClient(player, "MarkZombie", zombie)

			-- ç›‘å¬åƒµå°¸æ­»äº¡
			local humanoid = zombie:FindFirstChild("Humanoid")
			if humanoid then
				humanoid.Died:Connect(function()
					print("ğŸ’€ åƒµå°¸å·²æ­»äº¡ï¼å‘æ”¾å¥–åŠ±...")

					-- 1. åŠ  XP å’Œ ç”Ÿç‰©æ®‹æ¸£
					local stats = PlayerStats[player.UserId]
					stats.XP = stats.XP + 300
					stats.BioMatter = stats.BioMatter + 3
					print("ç©å®¶è·å¾— 300 XP, å½“å‰æ€»é‡: " .. stats.XP)

					-- 2. æ‰è½ç‰©å“ (ğŸ›‘ ä¿®å¤ç‚¹ï¼šä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼è·å–ä½ç½®)
					local dropPos = zombie:GetPivot().Position -- è¿™æ ·å†™æ— è®ºæœ‰æ²¡æœ‰RootPartéƒ½èƒ½æ‰¾åˆ°ä½ç½®

					SpawnLoot("CommonExtract", dropPos, 3, player) -- 3ä¸ªæ™®é€š
					SpawnLoot("RareExtract", dropPos, 2, player)   -- 2ä¸ªç½•è§

					-- 3. æ¸…ç†å°¸ä½“ (å»¶è¿Ÿ)
					game:GetService("Debris"):AddItem(zombie, 5)
				end)
			end
		else
			warn("âŒ é”™è¯¯ï¼šServerStorage/Enemies é‡Œæ²¡æ‰¾åˆ° EliteZombie æ¨¡å‹ï¼")
		end
	end
end)