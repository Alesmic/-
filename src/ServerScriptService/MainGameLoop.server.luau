local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local ServerStorage = game:GetService("ServerStorage")
local DataStoreService = game:GetService("DataStoreService")
local Debris = game:GetService("Debris")

-- å¼•å…¥é…ç½®
local GameConfig = require(ReplicatedStorage:WaitForChild("GameConfig"))

-- äº‹ä»¶å¼•ç”¨
local TutorialEvent = ReplicatedStorage:WaitForChild("TutorialEvent")
local StartLocation = Workspace:WaitForChild("TutorialStartLocation")
local ZombieSpawnPoint = Workspace:FindFirstChild("ZombieSpawnPoint")

-- [ä¿®å¤ 1] ç»Ÿä¸€ä½¿ç”¨æ–°çš„ DataStore åç§°ï¼Œä¸ PlayerDataSetup ä¿æŒä¸€è‡´
local DATA_STORE_NAME = "Player_Data_V3_Exp" 
local PlayerDataStore
pcall(function()
	PlayerDataStore = DataStoreService:GetDataStore(DATA_STORE_NAME)
end)

local PlayerStats = {} 

-- =============================================
-- 1. ç©å®¶æ•°æ®ç®¡ç†
-- =============================================
Players.PlayerAdded:Connect(function(player)
	local success, savedData
	if PlayerDataStore then
		success, savedData = pcall(function() return PlayerDataStore:GetAsync("User_"..player.UserId) end)
	end

	if success and savedData then
		PlayerStats[player.UserId] = savedData

		-- [ä¿®å¤ 2] æ•°æ®è¿ç§»ä¿é™©ï¼šå¦‚æœè¯»å–çš„æ˜¯æ—§æ•°æ®(æ— Exp)ï¼Œå¼ºåˆ¶åˆå§‹åŒ–ä¸º0
		if PlayerStats[player.UserId].Exp == nil then
			PlayerStats[player.UserId].Exp = PlayerStats[player.UserId].XP or 0
		end
		-- ç¡®ä¿ LabInventory å­˜åœ¨
		if PlayerStats[player.UserId].LabInventory == nil then
			PlayerStats[player.UserId].LabInventory = {}
		end
	else
		-- åˆå§‹åŒ–æ–°æ•°æ®
		PlayerStats[player.UserId] = { Exp = 0, BioMatter = 0, LabInventory = {} }
	end

	player.CharacterAdded:Connect(function(character)
		task.wait(0.5)
		if character.PrimaryPart then
			character:SetPrimaryPartCFrame(StartLocation.CFrame)
		else
			character:MoveTo(StartLocation.Position)
		end
	end)

	task.wait(2)
	TutorialEvent:FireClient(player, "StartObjective1")
	if PlayerStats[player.UserId] then
		TutorialEvent:FireClient(player, "UpdateBioMatter", PlayerStats[player.UserId].BioMatter)
		TutorialEvent:FireClient(player, "UpdateExp", PlayerStats[player.UserId].Exp)
	end
end)

Players.PlayerRemoving:Connect(function(player)
	-- [ä¼˜åŒ–] MainGameLoop ä¸å†è´Ÿè´£ä¿å­˜ï¼Œäº¤ç»™ PlayerDataSetup ç»Ÿä¸€ä¿å­˜ï¼Œé˜²æ­¢å†²çª
	-- è¿™é‡Œåªæ¸…ç†å†…å­˜è¡¨
	PlayerStats[player.UserId] = nil
end)

-- =============================================
-- 2. è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆæ‰è½ç‰©
-- =============================================
local function SpawnLoot(name, position, count, player, colorInfo)
	local lootFolder = ServerStorage:FindFirstChild("LootItems")
	local itemTemplate = lootFolder and lootFolder:FindFirstChild(name)

	if not itemTemplate then
		itemTemplate = Instance.new("Part")
		itemTemplate.Name = name
		itemTemplate.Size = Vector3.new(1, 1, 1)
		itemTemplate.CanCollide = true
		itemTemplate.Anchored = false
		itemTemplate.Shape = Enum.PartType.Ball
	end

	for i = 1, count do
		local loot = itemTemplate:Clone()
		loot.Position = position + Vector3.new(math.random(-3,3), 5, math.random(-3,3))
		loot.Parent = workspace

		if colorInfo then
			if typeof(colorInfo) == "Color3" then
				loot.Color = colorInfo
			elseif GameConfig.RarityColors and GameConfig.RarityColors[colorInfo] then
				loot.Color = GameConfig.RarityColors[colorInfo]
			elseif colorInfo == "Red" then
				loot.Color = Color3.fromRGB(255, 50, 50)
			elseif colorInfo == "Blue" then
				loot.Color = Color3.fromRGB(0, 170, 255)
			elseif colorInfo == "Green" then
				loot.Color = Color3.fromRGB(75, 180, 75)
			end
		end

		if loot:IsA("BasePart") then
			loot.Anchored = false
			loot.CanCollide = true
		end

		local prompt = Instance.new("ProximityPrompt")
		prompt.ObjectText = "Loot"
		prompt.ActionText = "Pick up " .. name
		prompt.HoldDuration = 0
		prompt.MaxActivationDistance = 10
		prompt.Parent = loot

		prompt.Triggered:Connect(function(triggerPlayer)
			if triggerPlayer == player then
				if PlayerStats[player.UserId] then
					table.insert(PlayerStats[player.UserId].LabInventory, name)
				end

				local backpack = player:FindFirstChild("Backpack")
				if backpack then
					local tool = Instance.new("Tool")
					tool.Name = name
					tool.RequiresHandle = false
					tool.Parent = backpack
					tool.ToolTip = name .. " x1"
				end

				TutorialEvent:FireClient(player, "LootPickedUp", name)
				loot:Destroy()
			end
		end)

		Debris:AddItem(loot, 60)
	end
end

-- =============================================
-- 3. è¾…åŠ©å‡½æ•°ï¼šç”ŸæˆæŒ‡å®šåƒµå°¸
-- =============================================
local function SpawnSpecificZombie(player, zombieType, offset)
	local config = GameConfig.Mobs[zombieType]
	if not config then 
		warn("âŒ GameConfig ä¸­æ‰¾ä¸åˆ°æ€ªç‰©é…ç½®: " .. tostring(zombieType))
		return 
	end

	local enemyFolder = ServerStorage:FindFirstChild("Enemies")
	local zombieTemplate = enemyFolder and enemyFolder:FindFirstChild("EliteZombie")

	if zombieTemplate then
		local zombie = zombieTemplate:Clone()
		zombie.Name = config.Name
		zombie.Parent = workspace

		if player.Character then
			local pivot = player.Character:GetPivot()
			zombie:PivotTo(pivot * CFrame.new(offset, 0, -20))
		end

		local humanoid = zombie:WaitForChild("Humanoid")
		humanoid.MaxHealth = config.HP
		humanoid.Health = config.HP

		if config.OutlineColor then
			local hl = Instance.new("Highlight")
			hl.FillTransparency = 1
			hl.OutlineColor = config.OutlineColor
			hl.Parent = zombie
		end

		TutorialEvent:FireClient(player, "MarkZombie", zombie)

		humanoid.Died:Connect(function()
			print("ğŸ’€ " .. config.Name .. " å·²æ­»äº¡")

			-- [ä¿®å¤ 3] ä½¿ç”¨ (config.XP or 0) é˜²æ­¢é…ç½®ç¼ºå¤±æŠ¥é”™
			local xpReward = config.XP or 0
			local bioReward = config.BioMatterDrop or 0

			-- æ›´æ–°å†…å­˜æ•°æ®
			if PlayerStats[player.UserId] then
				local stats = PlayerStats[player.UserId]
				-- ç¡®ä¿ stats.Exp ä¸æ˜¯ nil
				stats.Exp = (stats.Exp or 0) + xpReward
				stats.BioMatter = (stats.BioMatter or 0) + bioReward

				TutorialEvent:FireClient(player, "UpdateBioMatter", stats.BioMatter)
				TutorialEvent:FireClient(player, "UpdateExp", stats.Exp)
			end

			-- åŒæ­¥æ›´æ–° Leaderstats
			local leaderstats = player:FindFirstChild("leaderstats")
			if leaderstats then
				local bioVal = leaderstats:FindFirstChild("Biomass")
				if bioVal then bioVal.Value = bioVal.Value + bioReward end

				local expVal = leaderstats:FindFirstChild("Exp")
				if expVal then expVal.Value = expVal.Value + xpReward end
			end

			-- ç”Ÿæˆæ‰è½ç‰©
			local dropPos = zombie:GetPivot().Position
			if config.Drops then
				for _, dropData in ipairs(config.Drops) do
					SpawnLoot(dropData.ItemName, dropPos, dropData.Amount, player, dropData.Rarity or dropData.Color)
				end
			end

			Debris:AddItem(zombie, 5)
		end)
	end
end

-- =============================================
-- 4. äº‹ä»¶ç›‘å¬
-- =============================================
TutorialEvent.OnServerEvent:Connect(function(player, action, data)
	if action == "GiveWeapon" then
		local weaponFolder = ServerStorage:FindFirstChild("WeaponTools")
		if weaponFolder then
			local weapon = weaponFolder:FindFirstChild(data)
			if weapon then
				weapon:Clone().Parent = player.Backpack
				weapon:Clone().Parent = player.StarterGear
			end
		end

	elseif action == "SpawnZombie" then
		print("ğŸ§Ÿ æœåŠ¡å™¨ï¼šæ­£åœ¨ç”Ÿæˆåƒµå°¸æ³¢æ¬¡...")
		if not ZombieSpawnPoint then 
			SpawnSpecificZombie(player, "Normal Zombie", -6)
			SpawnSpecificZombie(player, "Elite Zombie", 6)
		else
			SpawnSpecificZombie(player, "Normal Zombie", -6)
			SpawnSpecificZombie(player, "Elite Zombie", 6)
		end
	end
end)