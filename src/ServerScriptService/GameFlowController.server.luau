-- Script: GameFlowController (åœ¨ ServerScriptService ä¸­)
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Debris = game:GetService("Debris") 

-- [è¾…åŠ©å‡½æ•°] è‡ªåŠ¨åˆ›å»ºç¼ºå¤±çš„äº‹ä»¶ (é˜²æ­¢æŠ¥é”™)
local function GetOrCreateEvent(name)
	local event = ReplicatedStorage:FindFirstChild(name)
	if not event then
		event = Instance.new("RemoteEvent")
		event.Name = name
		event.Parent = ReplicatedStorage
	end
	return event
end

-- !!! äº‹ä»¶å¼•ç”¨ !!!
local TutorialEvent = GetOrCreateEvent("TutorialEvent")
local sellBiomassEvent = GetOrCreateEvent("SellBiomassEvent")
local toggleWaypointEvent = GetOrCreateEvent("ToggleWaypointEvent")
local secondTriggerEvent = GetOrCreateEvent("SecondDialogueEvent")

-- !!! åœºæ™¯å¯¹è±¡ !!!
-- ç¡®ä¿ Workspace é‡Œæœ‰è¿™äº›åå­—çš„ Part
local labAnchor = workspace:WaitForChild("LabTeleportAnchor", 10) 
local startAnchor = workspace:WaitForChild("TutorialStartLocation", 10)

if not labAnchor then warn("âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ° LabTeleportAnchor") end
if not startAnchor then warn("âš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ° TutorialStartLocation") end

-- !!! é…ç½® !!!
local MTC_PER_RECYCLE = 100 -- æ±‡ç‡ï¼šæ¯ä¸ªç”Ÿç‰©è´¨ 100 MTC
local SECOND_VOICE_ASSET_ID = "rbxassetid://74061505906890" -- æ¬¢è¿è¯­éŸ³
local SECOND_VO_DURATION = 7.0

-- [å‡½æ•° 1: å›æ”¶ç®±å‡ºå”®é€»è¾‘]
local function handleSellBiomass(player)
	print("æ”¶åˆ° " .. player.Name .. " çš„å‡ºå”®è¯·æ±‚")

	-- 1. è·å– Leaderstats
	local leaderstats = player:FindFirstChild("leaderstats")
	if not leaderstats then 
		warn("âŒ æ‰¾ä¸åˆ° leaderstatsï¼Œæ— æ³•äº¤æ˜“")
		return 
	end

	-- 2. è·å–æ•°æ®å¯¹è±¡
	local biomass = leaderstats:FindFirstChild("Biomass")
	local mtc = leaderstats:FindFirstChild("MTC")

	if biomass and mtc then
		print("å½“å‰ç”Ÿç‰©è´¨: " .. biomass.Value .. ", å½“å‰ MTC: " .. mtc.Value)

		if biomass.Value > 0 then
			-- 3. è®¡ç®—è·å¾—çš„é’±
			local earnedMTC = biomass.Value * MTC_PER_RECYCLE

			-- 4. åŠ é’±
			mtc.Value = mtc.Value + earnedMTC

			-- 5. ç”Ÿç‰©è´¨æ¸…é›¶
			biomass.Value = 0

			print("ğŸ’° äº¤æ˜“æˆåŠŸï¼è·å¾—: " .. earnedMTC .. " MTC")

			-- 6. å…³é—­è·¯æ ‡å¹¶æ¨è¿›æµç¨‹
			toggleWaypointEvent:FireClient(player, false)

			-- ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ï¼Œç¡®ä¿å®¢æˆ·ç«¯UIæ›´æ–°
			task.wait(1)
			TutorialEvent:FireClient(player, "StartObjective4")
		else
			print("âš ï¸ ç©å®¶ç”Ÿç‰©è´¨ä¸º 0ï¼Œæ— æ³•å‡ºå”®")
		end
	else
		warn("âŒ leaderstats ä¸­ç¼ºå°‘ Biomass æˆ– MTC å€¼")
	end
end

-- [å‡½æ•° 2: åˆ°è¾¾å®éªŒå®¤åçš„æµç¨‹]
local function startSecondDialogue(player)
	print("è§¦å‘å®éªŒå®¤æ¬¢è¿æµç¨‹...")

	-- æ’­æ”¾è¯­éŸ³ (å¦‚æœæœ‰)
	local sound = Instance.new("Sound")
	sound.SoundId = SECOND_VOICE_ASSET_ID
	local character = player.Character
	if character and character:FindFirstChild("HumanoidRootPart") then
		sound.Parent = character.HumanoidRootPart
		sound:Play()
		Debris:AddItem(sound, SECOND_VO_DURATION + 1)
	end

	-- è§¦å‘å®¢æˆ·ç«¯å­—å¹•äº‹ä»¶
	secondTriggerEvent:FireClient(player)

	-- ç­‰å¾…ä¸€æ®µæ—¶é—´åå¼€å¯å›æ”¶ç®±è·¯æ ‡
	task.wait(SECOND_VO_DURATION + 1) 
	print("å¼€å¯å›æ”¶ç®±è·¯æ ‡")
	toggleWaypointEvent:FireClient(player, true) 
end

-- [å‡½æ•° 3: ä¼ é€é€»è¾‘] (ClientStoryManager è¯·æ±‚æ—¶è§¦å‘)
local function startLabObjective(player)
	print(player.Name .. " è¯·æ±‚è¿›å…¥å®éªŒå®¤æµç¨‹...")

	local character = player.Character
	if character and character:FindFirstChild("HumanoidRootPart") then
		-- ä¼ é€ç©å®¶
		if labAnchor then
			local targetCFrame = labAnchor.CFrame + Vector3.new(0, 3, 0)
			character:PivotTo(targetCFrame)
			print("âœ… ç©å®¶å·²ä¼ é€åˆ°å®éªŒå®¤")

			-- ä¼ é€åå¯åŠ¨æ¬¢è¿æµç¨‹
			task.wait(1)
			startSecondDialogue(player)
		else
			warn("âŒ æ— æ³•ä¼ é€ï¼šç¼ºå°‘ LabTeleportAnchor")
		end
	end
end

-- [ç›‘å¬ç©å®¶åŠ å…¥ - å¼ºåˆ¶ä¼ é€å‡ºç”Ÿç‚¹]
Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function(character)
		-- ç­‰å¾…ä¸€ä¸‹ç¡®ä¿è§’è‰²åŠ è½½å®Œæˆ
		task.wait(0.5)
		if startAnchor and character:FindFirstChild("HumanoidRootPart") then
			-- ä¼ é€åˆ° TutorialStartLocation
			character:PivotTo(startAnchor.CFrame + Vector3.new(0, 3, 0))
			print(player.Name .. " å·²ä¼ é€åˆ°åˆå§‹å‡ºç”Ÿç‚¹ã€‚")
		end
	end)
end)

-- [ç›‘å¬ä¼ é€äº‹ä»¶]
TutorialEvent.OnServerEvent:Connect(function(player, action)
	if action == "MoveToLab" then
		startLabObjective(player)
	end
end)

-- [ç›‘å¬å‡ºå”®äº‹ä»¶]
sellBiomassEvent.OnServerEvent:Connect(handleSellBiomass)